
[tasks.env_check]
dependencies = ["echo_env", "install_flutter_protobuf"]
condition = { env_set = [
  "BUILD_FLAG",
  "RUST_COMPILE_TARGET",
  "CRATE_TYPE",
  "TARGET_OS",
], channels = [
  "stable",
] }

[tasks.appflowy-core-dev-ios]
category = "Build"
dependencies = ["env_check"]
run_task = { name = [
  "setup-crate-type",
  "sdk-build-ios",
  "post-mobile-ios",
  "restore-crate-type",
] }

[tasks.appflowy-core-dev-android]
category = "Build"
dependencies = ["env_check"]
run_task = { name = [
  "setup-crate-type",
  "setup-sqlite-crate",
  "setup-sqlite-openssl",
  "sdk-build-android",
  "post-mobile-android",
  "restore-crate-type",
  "restore-sqlite-crate",
  "restore-sqlite-openssl",
] }

[tasks.sdk-build-ios]
private = true
script = [
  """
    cd rust-lib/
    rustup show
    echo cargo lipo --targets ${RUST_COMPILE_TARGET} --features "${FLUTTER_DESKTOP_FEATURES}"
    cargo lipo --targets ${RUST_COMPILE_TARGET} --features "${FLUTTER_DESKTOP_FEATURES}"
    cd ../
  """,
]
script_runner = "@shell"

[tasks.sdk-build-android]
private = true
script = [
  """
    cd rust-lib/
    rustup show
    rustup target add aarch64-linux-android \
      armv7-linux-androideabi \
      i686-linux-android \
      x86_64-linux-android
    DEST=${CARGO_MAKE_WORKSPACE_WORKING_DIRECTORY}/appflowy_flutter/android/app/src/main/jniLibs
    rm -rf $DEST/arm64-v8a \
      $DEST/armeabi-v7a \
      $DEST/x86 \
      $DEST/x86_64
    cargo ndk \
      -t arm64-v8a \
      -t armeabi-v7a \
      -t x86 \
      -t x86_64 \
      -o $DEST build --release
    cd ../
  """,
]
script_runner = "@shell"

[tasks.post-mobile-ios]
private = true
script = [
  """
    echo "ðŸš€ ðŸš€ ðŸš€  AppFlowy-Core for iOS platform build success"
    dart_ffi_dir= set ${CARGO_MAKE_WORKSPACE_WORKING_DIRECTORY}/appflowy_flutter/packages/appflowy_backend/${TARGET_OS}
    lib = set lib${LIB_NAME}.${LIB_EXT}

    echo "ðŸ’» ðŸ’» ðŸ’»  Copying ${CARGO_MAKE_WORKSPACE_WORKING_DIRECTORY}/rust-lib/target/${RUST_COMPILE_TARGET}/${BUILD_FLAG}/${lib} to ${dart_ffi_dir}/${lib}"
    rm -f ${dart_ffi_dir}/${lib}
    cp ${CARGO_MAKE_WORKSPACE_WORKING_DIRECTORY}/rust-lib/target/${RUST_COMPILE_TARGET}/${BUILD_FLAG}/${lib} \
    ${dart_ffi_dir}/${lib}

    echo "ðŸ’» ðŸ’» ðŸ’»  Copying ${CARGO_MAKE_WORKSPACE_WORKING_DIRECTORY}/rust-lib/${CARGO_MAKE_CRATE_NAME}/binding.h to ${dart_ffi_dir}/Classes/binding.h"
    rm -f ${dart_ffi_dir}/Classes/binding.h
    cp ${CARGO_MAKE_WORKSPACE_WORKING_DIRECTORY}/rust-lib/${CARGO_MAKE_CRATE_NAME}/binding.h \
    ${dart_ffi_dir}/Classes/binding.h
  """,
]
script_runner = "@duckscript"

[tasks.post-mobile-android]
private = true
script = [
  """
    echo "ðŸš€ ðŸš€ ðŸš€  AppFlowy-Core for Android platform build success"
    dart_ffi_dir= set ${CARGO_MAKE_WORKSPACE_WORKING_DIRECTORY}/appflowy_flutter/android/src/main/main/jniLibs
    lib = set lib${LIB_NAME}.so

    echo "ðŸ’» ðŸ’» ðŸ’»  Copied ${CARGO_MAKE_WORKSPACE_WORKING_DIRECTORY}/rust-lib/target/${RUST_COMPILE_TARGET}/${BUILD_FLAG}/${lib} to ${dart_ffi_dir}"
  """,
]
script_runner = "@duckscript"
